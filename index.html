<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMLAK PORTFÃ–Y ASÄ°STANI - v73 PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- GÃœVENLÄ°K KÄ°LÄ°DÄ° STÄ°LLERÄ° (EN BAÅA EKLENDÄ°) --- */
        #lockScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, #2c3e50 0%, #000 100%); z-index: 999999; display: flex; flex-direction: column; align-items: center; justify-content: center; font-family: 'Segoe UI', sans-serif; text-align: center; }
        .lock-card { background: rgba(255, 255, 255, 0.1); padding: 40px; border-radius: 20px; backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2); width: 90%; max-width: 400px; box-shadow: 0 50px 100px rgba(0,0,0,0.5); color: white; }
        .device-id-box { background: white; color: #333; font-family: monospace; font-size: 24px; font-weight: bold; letter-spacing: 2px; padding: 15px; margin: 20px 0; border-radius: 8px; border: 2px dashed #f39c12; cursor: pointer; user-select: all; }
        .lock-input { width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 8px; font-size: 18px; text-align: center; box-sizing: border-box; }
        .lock-btn { width: 100%; padding: 15px; border: none; border-radius: 8px; background: #27ae60; color: white; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 15px; transition: 0.3s; }
        .lock-btn:active { transform: scale(0.98); }
        #appContainer { display: none; } /* Kilit aÃ§Ä±lana kadar uygulama gizli */

        /* --- SÄ°ZÄ°N ORÄ°JÄ°NAL CSS KODLARINIZ (v73) --- */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db; 
            --shared: #9b59b6;    
            --accent: #27ae60;    
            --danger: #c0392b;    
            --link-color: #e67e22; 
            --calc-color: #2980b9; 
            --tool-bg: #f8f9fa;
            --sold: #d63031;
            --warning-bg: #fff3cd;
            --alert-bg: #f8d7da;
            --whatsapp: #25D366;
            --excel: #217346;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f3; margin: 0; padding: 10px; color: #333; }
        
        .container { max-width: 1800px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* HEADER & SAAT */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #eee; padding-bottom: 15px; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .app-title-group h1 { margin: 0; line-height: 1; font-size: 24px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .app-subtitle { font-size: 12px; font-weight: 600; color: #7f8c8d; letter-spacing: 2px; margin-top: 5px; }

        /* MODERN SAAT TASARIMI */
        .clock-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #fff;
            padding: 8px 20px;
            border-radius: 50px; /* KapsÃ¼l gÃ¶rÃ¼nÃ¼mÃ¼ */
            font-family: 'Segoe UI', sans-serif;
            font-weight: 600;
            font-size: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        .clock-container:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.25); }
        .clock-input { background: rgba(255,255,255,0.9); border: none; padding: 4px; border-radius: 4px; font-size: 14px; width: 90px; color:#333; display:none; outline:none; }
        .alarm-btn { background: rgba(255,255,255,0.1); border: none; color: white; cursor: pointer; font-size: 16px; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .alarm-btn:hover { background: rgba(255,255,255,0.3); }
        
        /* Modern Alarm Animasyonu */
        .alarm-active { 
            background: linear-gradient(135deg, #c0392b, #e74c3c) !important;
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(192, 57, 43, 0); }
            100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); }
        }

        /* Ã–ZET PANELÄ° (DASHBOARD) */
        .dashboard-stats { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .stat-card { flex: 1; min-width: 100px; background: #f8f9fa; padding: 10px; border-radius: 6px; border-left: 5px solid #ccc; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .stat-card.s-satilik { border-color: var(--accent); }
        .stat-card.s-kiralik { border-color: var(--link-color); }
        .stat-card.s-satildi { border-color: var(--sold); }
        .stat-label { font-size: 11px; font-weight: bold; color: #555; text-transform: uppercase; }
        .stat-value { font-size: 20px; font-weight: bold; color: #333; }

        /* Toolbar & DiÄŸerleri */
        .tools-bar { display: flex; gap: 8px; background: var(--tool-bg); padding: 8px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ddd; flex-wrap: wrap; }
        .tool-btn { border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 700; color: white; display: flex; align-items: center; gap: 6px; transition: all 0.2s; text-decoration: none; position: relative; }
        .tool-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-unutma { background-color: var(--danger); }
        .btn-crm { background-color: var(--accent); }
        .btn-calc { background-color: var(--calc-color); }
        .btn-link { background-color: var(--link-color); }
        .btn-backup { background: #f39c12; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .notification-badge { position: absolute; top: -8px; right: -8px; background-color: red; color: white; border-radius: 50%; padding: 3px 6px; font-size: 10px; border: 2px solid white; display: none; }

        /* Form AlanÄ± */
        .input-panel { background: #fdfdfd; padding: 15px; border: 1px solid #ddd; border-left: 6px solid var(--primary); margin-bottom: 20px; border-radius: 4px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .form-group label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 4px; color: #555; text-transform: uppercase; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        .currency-group { display: flex; gap: 5px; }
        .currency-group select { width: 70px; flex-shrink: 0; background: #eee; font-weight: bold; }
        
        /* KOMÄ°SYON KUTUCUÄU */
        .instant-comm-box { background: #e8f8f5; border: 1px dashed #27ae60; color: #27ae60; padding: 5px; font-size: 11px; border-radius: 4px; margin-top: 5px; font-weight: bold; display:none; }

        .auth-box { grid-column: span 2; display: flex; gap: 10px; background: #eafaf1; padding: 10px; border: 1px dashed var(--accent); border-radius: 6px; }
        
        /* ALT SATIR DÃœZENÄ° */
        .form-bottom-row { grid-column: 1 / -1; display: flex; gap: 15px; align-items: flex-end; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee; }
        .form-bottom-item { flex: 1; }
        .form-bottom-action { flex: 0 0 auto; display: flex; gap: 5px; }

        .btn-save { background: var(--accent); color: white; border: none; padding: 0 30px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; height: 42px; display: flex; align-items: center; justify-content: center; white-space: nowrap; }
        .btn-delete-rec { background: var(--danger); color: white; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; font-weight: bold; display: none; height: 42px; }
        .btn-cancel { background: #7f8c8d; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; display: none; margin-left: auto; }

        /* Tablo */
        table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 12px; table-layout: fixed; }
        th { background: #34495e; color: white; padding: 8px 4px; text-align: left; vertical-align: middle; word-wrap: break-word; font-size: 11px; }
        td { padding: 6px 4px; border-bottom: 1px solid #eee; vertical-align: top; word-wrap: break-word; }
        tr:hover { background: #f9f9f9; }
        
        tr.row-sold { background-color: #fff5f5; color: #999; }
        tr.row-rented { background-color: #fcf8e3; color: #777; }
        tr.row-selected { background-color: #d1f2eb !important; }
        
        .badge { padding: 2px 4px; border-radius: 3px; color: white; font-size: 9px; font-weight: bold; display:inline-block; margin-bottom: 2px; }
        .satilik { background: #27ae60; } .kiralik { background: #e67e22; } .kirmizi-etiket { background: var(--sold) !important; }
        .badge-own { background: var(--secondary); } .badge-shared { background: var(--shared); }
        .type-text { display: block; font-weight: 900; text-transform: uppercase; font-size: 10px; margin-top: 2px; color: #444; }
        
        /* Linkler */
        .direct-link-btn { display: inline-block; background-color: #3498db; color: white; text-decoration: none; padding: 3px 6px; border-radius: 3px; font-size: 10px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; font-weight: 600; }
        .link-sahibinden { background-color: #f1c40f; color: black; } .link-hepsi { background-color: #e74c3c; } 
        .link-maps { background-color: #27ae60; color: white; } .link-dosya { background-color: #95a5a6; border: 1px solid #7f8c8d; }

        /* Filtre */
        .filter-bar { background: var(--primary); padding: 12px; border-radius: 6px; display: flex; gap: 8px; flex-wrap: wrap; color: white; align-items: center; }
        .filter-bar input, .filter-bar select { padding: 6px; border: none; border-radius: 4px; color: #333; font-size: 12px; }
        .btn-clear-filter { background: #95a5a6; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: auto; }
        .btn-print-selected { background: #8e44ad; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; display:flex; align-items:center; gap:5px; font-size: 11px; }
        .btn-whatsapp-selected { background: var(--whatsapp); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; display:flex; align-items:center; gap:5px; font-size: 11px; }
        .btn-excel { background: #217346; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; display:flex; align-items:center; gap:5px; font-size: 11px; }

        /* CRM Badges */
        .badge-crm-safe { background: #27ae60; color:white; font-size:12px; padding:6px 10px; border-radius:4px; display:inline-block; min-width:80px; text-align:center; }
        .badge-crm-danger { background: #c0392b; color:white; font-size:13px; font-weight:900; padding:6px 10px; border-radius:4px; display:inline-block; min-width:80px; text-align:center; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; overflow-y: hidden; }
        .modal-content { background: white; margin: 2% auto; padding: 20px; width: 95%; border-radius: 8px; position: relative; max-height: 90vh; display: flex; flex-direction: column; overflow-y: auto; }
        .crm-modal-content { background: white; margin: 2% auto; padding: 20px; width: 95%; border-radius: 8px; position: relative; height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .tool-modal-content { width: 400px; max-width: 90%; margin: 10% auto; }
        .checklist-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .checklist-item.checked span { text-decoration: line-through; color: #aaa; }

        /* Ä°mar & DiÄŸer Modallar */
        .imar-list-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-height: 250px; overflow-y: auto; padding: 5px; border: 1px solid #eee; background: #fdfdfd; border-radius: 4px; margin-bottom: 15px; }
        .btn-imar-select { padding: 10px; background: #34495e; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; display: flex; align-items: center; justify-content: space-between; }
        .btn-imar-delete { background: #c0392b; color: white; border:none; border-radius: 3px; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 5px; }

        /* Hesap Makinesi & Tablar */
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .calc-btn { padding: 12px; font-size: 18px; cursor: pointer; background: #eee; border: none; border-radius: 4px; } 
        .calc-btn.op { background: var(--secondary); color: white; } .calc-btn.eq { background: var(--accent); color: white; grid-column: span 2; }
        .calc-screen { width: 95%; padding: 10px; font-size: 24px; text-align: right; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .tab-buttons { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; white-space: nowrap; border-bottom: 3px solid transparent; }
        .tab-btn.active { border-bottom-color: var(--secondary); color: var(--secondary); font-weight: bold; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        
        /* CRM Style */
        .crm-header { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; flex-shrink: 0; }
        .crm-tab { padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 6px; border: 1px solid #eee; background: #f9f9f9; white-space: nowrap; }
        .crm-tab.active { background: var(--accent); color: white; border-color: var(--accent); }
        .crm-content-scrollable { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
        .crm-input-panel { background: #f1f2f6; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 5px solid var(--accent); }
        .crm-input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        .crm-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .crm-table-container { overflow-x: auto; }
        
        .print-only { display: none; }

        @media screen and (max-width: 900px) {
            .form-bottom-row { flex-direction: column; align-items: stretch; gap:10px; }
            .form-bottom-action { width: 100%; justify-content: flex-end; }
            .btn-save { width: 100%; }
            .select-col-header, .select-col-cell { width: 20px !important; }
            header { flex-direction: column; align-items: stretch; text-align: center; }
            .clock-container { justify-content: center; }
            .dashboard-stats { flex-direction: row; overflow-x: auto; }
        }

        /* YAZDIRMA AYARLARI */
        @media print { 
            body, .container, #appContainer { background-color: white !important; margin: 0; padding: 0; }
            .input-panel, .filter-bar, .backup-controls, .tools-bar, .clock-container, .dashboard-stats, .no-print { display: none !important; } 
            .badge-own, .badge-shared { display: none !important; } 
            .print-only { display: table-cell !important; } 
            #appContainer { display: block !important; } 
            
            table { width: 100%; border-collapse: collapse; font-size: 10px; border: 1px solid #ccc; }
            th { background-color: #f1f1f1 !important; color: black !important; border: 1px solid #ccc; padding: 5px; text-transform: uppercase; font-weight: 800; }
            td { border: 1px solid #ccc; padding: 5px; vertical-align: top; }
            tr { page-break-inside: avoid; }
            
            thead { display: table-header-group !important; }
            tr { display: table-row !important; }

            body.print-selected-mode tbody tr:not(.row-selected) { display: none !important; }
            body.print-selected-mode .select-col-header, 
            body.print-selected-mode .select-col-cell { display: none !important; }
            
            /* Printte kilidi gizle */
            #lockScreen { display: none !important; }
        }
    </style>
</head>
<body>

<div id="lockScreen">
    <div class="lock-card">
        <i class="fa-solid fa-shield-halved" style="font-size: 50px; color: #27ae60; margin-bottom: 20px;"></i>
        <h2>LÄ°SANS KONTROLÃœ</h2>
        <p style="color:#ddd; font-size:13px;">Bu cihaz sisteme kayÄ±tlÄ± deÄŸil.<br>AÅŸaÄŸÄ±daki kodu yetkiliye ileterek ÅŸifre alÄ±nÄ±z.</p>
        
        <div class="device-id-box" id="showDeviceID" onclick="copyID()" title="Kopyalamak iÃ§in tÄ±kla">...</div>
        <div id="copyHint" style="font-size:11px; color:#aaa; margin-top:-15px; margin-bottom:15px;">Kopyalamak iÃ§in koda dokunun</div>
        
        <input type="text" id="licenseKeyInput" class="lock-input" placeholder="Åifreyi Girin">
        <button class="lock-btn" onclick="verifyLicense()">SÄ°STEMÄ° AÃ‡</button>
        <p id="secMsg" style="display:none; margin-top:15px; font-weight:bold; color:#e74c3c;"></p>
    </div>
</div>

<div id="appContainer">
    <div class="container">
        <header>
            <div class="app-title-group">
                <h1>ğŸ¢ EMLAK PORTFÃ–Y ASÄ°STANI <span style="font-size:12px; color:#27ae60; border:1px solid #27ae60; padding:2px 8px; border-radius:10px; vertical-align:middle;">v73</span></h1>
                <div class="app-subtitle">Profesyonel Emlak YÃ¶netim Sistemi</div>
            </div>
            
            <div class="clock-container" id="digitalClockBox">
                <i class="fa-regular fa-clock"></i>
                <span id="digitalClockDisplay" style="letter-spacing:1px;">00:00:00</span>
                <button class="alarm-btn" onclick="toggleAlarmInput()" title="Alarm Kur"><i class="fa-solid fa-bell"></i></button>
                <input type="time" id="alarmTimeInput" class="clock-input" onchange="setAlarm(this.value)">
            </div>

            <div class="backup-controls">
                <input type="file" id="fileUpload" style="display:none;" accept=".json, .txt, .text" onclick="this.value=null" onchange="uploadData(this)">
                <button class="btn-backup" onclick="document.getElementById('fileUpload').click()"><i class="fa-solid fa-folder-open"></i> YÃœKLE</button>
                <button class="btn-backup" onclick="downloadData()"><i class="fa-solid fa-floppy-disk"></i> YEDEKLE</button>
            </div>
        </header>

        <div class="tools-bar">
            <button class="tool-btn btn-unutma" onclick="openModal('checklistModal'); renderChecklist();">
                <i class="fa-solid fa-bell"></i> UNUTMA
                <span id="chkBadge" class="notification-badge">0</span>
            </button>
            
            <button class="tool-btn btn-crm" onclick="openCRM()"><i class="fa-solid fa-users"></i> CRM</button>
            <button class="tool-btn btn-calc" onclick="openModal('calcModal')"><i class="fa-solid fa-calculator"></i> HESAP</button>
            <button class="tool-btn btn-calc" onclick="openModal('currencyModal'); fetchCurrency();"><i class="fa-solid fa-money-bill-transfer"></i> DÃ–VÄ°Z</button>
            <button class="tool-btn btn-calc" onclick="openModal('realEstateCalcModal')"><i class="fa-solid fa-file-contract"></i> EMLAK</button>
            <a href="https://parselsorgu.tkgm.gov.tr/" target="_blank" class="tool-btn btn-link"><i class="fa-solid fa-map-location-dot"></i> TKGM</a>
            <button class="tool-btn btn-link" onclick="openModal('eImarModal'); renderImarButtons();"><i class="fa-solid fa-city"></i> BELEDÄ°YE</button>
        </div>

        <div class="input-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                <span id="formTitle" style="font-weight:bold; color:var(--primary); font-size:1.1em;">â• Yeni PortfÃ¶y Ekle</span>
                <button id="btnCancel" class="btn-cancel" onclick="resetForm()">Ä°PTAL</button>
            </div>
            <div class="form-grid">
                <div class="form-group"><label>PORTFÃ–Y SAHÄ°BÄ°</label><select id="inpOwnership"><option>BANA AÄ°T</option><option>PAYLAÅIMLI</option></select></div>
                <div class="form-group"><label>Menkul Cinsi</label><select id="inpType"></select></div>
                <div class="form-group"><label>Ä°ÅŸlem TÃ¼rÃ¼</label><select id="inpStatus"><option>SatÄ±lÄ±k</option><option>KiralÄ±k</option><option>Devren</option><option style="color:red; font-weight:bold;">SatÄ±ldÄ±</option><option style="color:red; font-weight:bold;">KiralandÄ±</option></select></div>
                
                <div class="form-group"><label>Ä°L</label><select id="inpCity" onchange="handleCityChange('inpCity', 'inpDistrict', 'dl_mahalle_ekle')"><option value="Antalya">Antalya</option></select></div>
                
                <div class="form-group">
                    <label>Ä°lÃ§e</label>
                    <input type="text" list="dl_ilce_ekle" id="inpDistrict" placeholder="SeÃ§/Yaz" oninput="loadMahalleler('inpCity', 'inpDistrict', 'dl_mahalle_ekle')" autocomplete="off">
                    <datalist id="dl_ilce_ekle"></datalist>
                </div>

                <div class="form-group"><label>Mahalle</label><input type="text" list="dl_mahalle_ekle" id="inpNeighborhood" placeholder="YazÄ±nÄ±z" autocomplete="off"><datalist id="dl_mahalle_ekle"></datalist></div>
                
                <div class="form-group"><label>Oda</label><input type="text" id="inpRooms" placeholder="3+1"></div>
                
                <div class="form-group"><label>Kat</label><select id="inpFloor"></select></div>
                
                <div class="form-group"><label>Kat SayÄ±sÄ±</label><input type="number" id="inpFloorCount"></div>
                <div class="form-group"><label>BrÃ¼t mÂ²</label><input type="number" id="inpGross"></div>
                <div class="form-group"><label>Net mÂ²</label><input type="number" id="inpNet"></div>
                <div class="form-group"><label>Fiyat</label>
                    <div class="currency-group">
                        <input type="text" id="inpPrice" placeholder="5.000.000" oninput="formatCurrency(this)">
                        <select id="inpCurrency"><option value="â‚º">TL</option><option value="$">USD</option><option value="â‚¬">EUR</option><option value="Â£">GBP</option></select>
                    </div>
                    <div id="instantComm" class="instant-comm-box"></div>
                </div>
                <div class="auth-box">
                    <div class="form-group" style="flex:1;"><label>Yetki BaÅŸlangÄ±Ã§</label><input type="date" id="inpAuthStart"></div>
                    <div class="form-group" style="flex:1;"><label>Yetki BitiÅŸ</label><input type="date" id="inpAuthEnd"></div>
                </div>
                <div class="form-group"><label>MÃ¼ÅŸteri Ad Soyad</label><input type="text" id="inpRef"></div>
                <div class="form-group"><label>MÃ¼ÅŸteri Telefon</label><input type="text" id="inpPhone" placeholder="0 (5XX)..." maxlength="17" oninput="formatPhone(this)"></div>
                
                <div class="form-bottom-row">
                    <div class="form-group form-bottom-item">
                        <label>Dosya / Link</label>
                        <textarea id="inpLink" placeholder="Linkler..." class="auto-expand" style="height:42px;"></textarea>
                    </div>
                    <div class="form-group form-bottom-item">
                        <label>AÃ§Ä±klama</label>
                        <textarea id="inpDesc" class="auto-expand" placeholder="Detaylar..." oninput="autoResize(this)" style="height:42px;"></textarea>
                    </div>
                    <div class="form-bottom-action">
                        <button id="btnSave" class="btn-save" onclick="handleSave()">KAYDET</button>
                        <button id="btnDelete" class="btn-delete-rec" onclick="deleteFromForm()">SÄ°L</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-stats" id="dashboard">
            <div class="stat-card s-satilik"><div><div class="stat-label">SatÄ±lÄ±k</div><div class="stat-value" id="countSatilik">0</div></div><i class="fa-solid fa-house" style="color:#ddd; font-size:24px;"></i></div>
            <div class="stat-card s-kiralik"><div><div class="stat-label">KiralÄ±k</div><div class="stat-value" id="countKiralik">0</div></div><i class="fa-solid fa-key" style="color:#ddd; font-size:24px;"></i></div>
            <div class="stat-card s-satildi"><div><div class="stat-label">SatÄ±ldÄ±/Kir.</div><div class="stat-value" id="countSatildi">0</div></div><i class="fa-solid fa-handshake" style="color:#ddd; font-size:24px;"></i></div>
            <div class="stat-card"><div><div class="stat-label">Toplam</div><div class="stat-value" id="countTotal">0</div></div><i class="fa-solid fa-list" style="color:#ddd; font-size:24px;"></i></div>
        </div>

        <div class="filter-bar">
            <span>ğŸ”</span> <input type="text" id="searchBox" placeholder="Ara..." onkeyup="renderTable()" style="width:90px;">
            <select id="filterOwnership" onchange="renderTable()"><option value="all">TÃ¼m</option><option>BANA AÄ°T</option><option>PAYLAÅIMLI</option></select>
            <select id="filterType" onchange="renderTable()"><option value="all">TÃ¼m TÃ¼r</option></select>
            <select id="filterStatus" onchange="renderTable()"><option value="all">Durum</option><option>SatÄ±lÄ±k</option><option>KiralÄ±k</option><option>Devren</option><option style="color:red;">SatÄ±ldÄ±</option><option style="color:red;">KiralandÄ±</option></select>
            
            <select id="filterCity" onchange="handleCityChange('filterCity', 'filterDistrict', 'dl_mahalle_filtre'); renderTable();">
                </select>
            
            <select id="filterDistrict" onchange="loadMahalleler('filterCity', 'filterDistrict', 'dl_mahalle_filtre'); renderTable();"><option value="all">Ä°lÃ§e</option></select>
            <input type="text" list="dl_mahalle_filtre" id="filterNeighborhood" placeholder="Mahalle" onkeyup="renderTable()" style="width:70px;" autocomplete="off"><datalist id="dl_mahalle_filtre"></datalist>
            
            <input type="text" id="filterRooms" placeholder="Oda" onkeyup="renderTable()" style="width:50px;">
            <input type="text" id="filterMinPrice" placeholder="Min" oninput="formatCurrency(this); renderTable()" style="width:60px;"> 
            <input type="text" id="filterMaxPrice" placeholder="Max" oninput="formatCurrency(this); renderTable()" style="width:60px;">
            <button class="btn-clear-filter" onclick="clearFilters()"><i class="fa-solid fa-rotate-left"></i></button>
            
            <button class="btn-excel" onclick="exportSelectedToExcel()">
                <i class="fa-solid fa-file-excel"></i> KAYDET EXCEL
            </button>
            
            <button class="btn-print-selected" onclick="printSelected()">
                <i class="fa-solid fa-file-pdf"></i> YAZDIR PDF
            </button>
            <button class="btn-whatsapp-selected" onclick="sendSelectedToWhatsapp()">
                <i class="fa-brands fa-whatsapp"></i> WP
            </button>
        </div>

        <table id="portfolioTable">
            <thead>
                <tr>
                    <th width="20" class="select-col-header no-print">
                        <input type="checkbox" id="masterCheckbox" onchange="toggleAllSelections(this)" style="cursor:pointer;" title="SeÃ§">
                    </th> 
                    <th width="12%">TÃœR</th>
                    <th width="15%">Lokasyon</th>
                    <th width="10%">Ã–zellik</th>
                    <th width="10%">mÂ² (B/N)</th>
                    <th width="12%">Fiyat</th>
                    <th width="12%">MÃ¼ÅŸteri</th>
                    <th width="8%">Yetki</th>
                    <th class="no-print" width="6%" style="text-align:center;">Link</th>
                    <th class="no-print" width="5%" style="text-align:center;">Not</th>
                    <th class="no-print" width="8%">Ä°ÅŸlem</th>
                    <th class="print-only">AÃ§Ä±klama</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="legal-footer" style="margin-top:20px; font-size:12px; color:#aaa; text-align:center;">Veriler yerel tarayÄ±cÄ±da saklanÄ±r. (v73)</div>
    </div>
</div>

<div id="eImarModal" class="modal" onclick="closeModalOutside(event, 'eImarModal')">
    <div class="modal-content tool-modal-content" style="width:500px;">
        <div style="display:flex;justify-content:space-between; margin-bottom:15px; border-bottom:2px solid #e67e22; padding-bottom:10px;">
            <h3 style="color:#e67e22; margin:0;"><i class="fa-solid fa-city"></i> Ä°mar ve Belediye</h3>
            <span onclick="closeModal('eImarModal')" style="cursor:pointer;font-size:24px;">&times;</span>
        </div>
        <div style="font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">â­ KAYITLI BELEDÄ°YELER:</div>
        <div id="imarListContainer" class="imar-list-container"></div>
        <div style="background:#f9f9f9; padding:15px; border-radius:6px; border:1px solid #ddd;">
            <div style="font-size:12px; font-weight:bold; color:#333; margin-bottom:10px;">ğŸ” LÄ°NK EKLE</div>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="imarCityInput" placeholder="Ä°l" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
                <input type="text" id="imarDistInput" placeholder="Ä°lÃ§e" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
            </div>
            <div style="margin-bottom:10px;">
                <input type="text" id="imarUrlInput" placeholder="Link (https://...)" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;">
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="searchGoogleImar()" style="flex:1; background:#f39c12; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer; font-weight:bold;">Google Ara</button>
                <button onclick="addImarLink()" style="flex:1; background:#27ae60; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer; font-weight:bold;">Ekle</button>
            </div>
        </div>
    </div>
</div>

<div id="checklistModal" class="modal" onclick="closeModalOutside(event, 'checklistModal')"><div class="modal-content tool-modal-content"><div style="display:flex;justify-content:space-between; margin-bottom:15px; border-bottom:2px solid #c0392b; padding-bottom:10px;"><h3 style="color:#c0392b; margin:0;"><i class="fa-solid fa-bell"></i> UNUTMA!</h3><span onclick="closeModal('checklistModal')" style="cursor:pointer;font-size:24px;">&times;</span></div><div style="display:flex; gap:10px; margin-bottom:15px;"><input type="text" id="newCheckItem" placeholder="HatÄ±rlatma ekle..." onkeypress="if(event.key==='Enter') addCheckItem()"><button class="btn-save" style="flex:0; width:60px; background:#c0392b;" onclick="addCheckItem()">EKLE</button></div><div id="checklistContainer" style="max-height:400px; overflow-y:auto; border:1px solid #eee; border-radius:4px;"></div></div></div>

<div id="crmModal" class="modal" onclick="closeModalOutside(event, 'crmModal')">
    <div class="crm-modal-content">
        <div style="display:flex;justify-content:space-between; margin-bottom:10px; flex-shrink:0;">
            <h3>ğŸ‘¥ MÃ¼ÅŸteri Ä°liÅŸkileri (CRM)</h3>
            <span onclick="closeModal('crmModal')" style="cursor:pointer;font-size:24px;">&times;</span>
        </div>
        <div class="crm-header">
            <div id="tab1" class="crm-tab active" onclick="switchCRMTab('investors')">ğŸ’° Talep Havuzu</div>
            <div id="tab2" class="crm-tab" onclick="switchCRMTab('network')">ğŸ“¢ Etki Ã‡evresi</div>
        </div>
        
        <div class="crm-content-scrollable">
            <div id="crmInvestors" class="crm-section" style="display:block;">
                <div class="crm-input-panel">
                    <div class="crm-input-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="form-group"><label>Ad Soyad</label><input type="text" id="invName"></div>
                        <div class="form-group"><label>Telefon</label><input type="text" id="invPhone" placeholder="05XX..." oninput="formatPhone(this)"></div>
                        <div class="form-group"><label>Talep Tipi</label><select id="invType"><option>Daire</option><option>Villa</option><option>Arsa</option><option>Ä°ÅŸyeri</option><option>YatÄ±rÄ±mlÄ±k</option></select></div>
                        <div class="form-group"><label>BÃ¶lge Tercihi</label><input type="text" id="invRegion" placeholder="Lara, KonyaaltÄ±..."></div>
                        <div class="form-group"><label>BÃ¼tÃ§e (Max)</label><input type="text" id="invBudget" oninput="formatCurrency(this)"></div>
                        <div class="form-group"><label>Durum</label><select id="invStatus"><option value="SÄ±cak">ğŸ”¥ SÄ±cak (Acil)</option><option value="IlÄ±k">âš–ï¸ IlÄ±k (Normal)</option><option value="SoÄŸuk">ğŸ§Š SoÄŸuk (Beklemede)</option></select></div>
                        <div class="form-group" style="grid-column: span 2;"><label>Notlar</label><textarea id="invNote" rows="1" class="auto-expand"></textarea></div>
                    </div>
                    <div class="crm-buttons">
                        <button class="btn-save" onclick="saveCRMInvestor()" id="btnInvSave">KAYDET</button>
                        <button id="btnInvDelete" class="btn-delete-rec" onclick="deleteCRMInvestor()">SÄ°L</button>
                        <button id="btnInvCancel" class="btn-cancel" onclick="resetCRMForm('investors')">Ä°PTAL</button>
                    </div>
                </div>
                <div class="crm-table-container">
                    <table class="crm-table">
                        <thead><tr><th width="15%">Ad Soyad</th><th width="12%">Telefon</th><th width="20%">Talep / BÃ¶lge</th><th width="13%">BÃ¼tÃ§e</th><th width="10%">Durum</th><th width="20%">Notlar</th><th width="10%">Ä°ÅŸlem</th></tr></thead>
                        <tbody id="investorTableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="crmNetwork" class="crm-section" style="display:none;">
                <div class="crm-input-panel">
                    <div class="crm-input-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="form-group"><label>Ad Soyad</label><input type="text" id="netName"></div>
                        <div class="form-group"><label>Telefon</label><input type="text" id="netPhone" oninput="formatPhone(this)"></div>
                        <div class="form-group"><label>Meslek / Unvan</label><input type="text" id="netJob"></div>
                        <div class="form-group"><label>Åehir</label><input type="text" id="netCity" value="Antalya"></div>
                        <div class="form-group"><label>YakÄ±nlÄ±k / Ref.</label><input type="text" id="netRelation" placeholder="ArkadaÅŸ, Eski MÃ¼ÅŸteri..."></div>
                        <div class="form-group"><label>Son Arama</label><input type="date" id="netLastCall"></div>
                        <div class="form-group" style="grid-column: span 3;"><label>AÃ§Ä±klama / Potansiyel</label><textarea id="netNote" rows="1" class="auto-expand"></textarea></div>
                    </div>
                    <div class="crm-buttons">
                        <button class="btn-save" onclick="saveCRMNetwork()" id="btnNetSave">KAYDET</button>
                        <button id="btnNetDelete" class="btn-delete-rec" onclick="deleteCRMNetwork()">SÄ°L</button>
                        <button id="btnNetCancel" class="btn-cancel" onclick="resetCRMForm('network')">Ä°PTAL</button>
                    </div>
                </div>
                <div class="crm-table-container">
                    <table class="crm-table">
                        <thead><tr><th width="16%">Ad Soyad</th><th width="12%">Meslek/Åehir</th><th width="12%">Telefon</th><th width="10%">YakÄ±nlÄ±k</th><th width="10%">Son Arama</th><th width="8%">Durum</th><th width="14%">Notlar</th><th width="18%">Ä°ÅŸlem</th></tr></thead>
                        <tbody id="networkTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="descModal" class="modal" onclick="closeModalOutside(event, 'descModal')"><div class="modal-content"><span onclick="closeModal('descModal')" style="cursor:pointer;float:right;font-size:24px;">&times;</span><h3>ğŸ“ Notlar</h3><p id="modalText" style="white-space: pre-wrap; margin-top:10px;"></p></div></div>

<div id="calcModal" class="modal" onclick="closeModalOutside(event, 'calcModal')">
    <div class="modal-content tool-modal-content">
        <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
            <h3>ğŸ§® Hesap Makinesi</h3><span onclick="closeModal('calcModal')" style="cursor:pointer;font-size:24px;">&times;</span>
        </div>
        <input type="text" id="calcDisplay" class="calc-screen" readonly>
        <div class="calc-grid">
            <button class="calc-btn" onclick="calcInput('7')">7</button>
            <button class="calc-btn" onclick="calcInput('8')">8</button>
            <button class="calc-btn" onclick="calcInput('9')">9</button>
            <button class="calc-btn op" onclick="calcInput('/')">Ã·</button>
            <button class="calc-btn" onclick="calcInput('4')">4</button>
            <button class="calc-btn" onclick="calcInput('5')">5</button>
            <button class="calc-btn" onclick="calcInput('6')">6</button>
            <button class="calc-btn op" onclick="calcInput('*')">Ã—</button>
            <button class="calc-btn" onclick="calcInput('1')">1</button>
            <button class="calc-btn" onclick="calcInput('2')">2</button>
            <button class="calc-btn" onclick="calcInput('3')">3</button>
            <button class="calc-btn op" onclick="calcInput('-')">-</button>
            <button class="calc-btn" onclick="calcInput('0')">0</button>
            <button class="calc-btn" onclick="calcInput('.')">.</button>
            <button class="calc-btn op" onclick="calcInput('%')">%</button>
            <button class="calc-btn op" onclick="calcInput('+')">+</button>
            <button class="calc-btn" onclick="calcClear()">C</button>
            <button class="calc-btn eq" onclick="calcResult()">=</button>
        </div>
    </div>
</div>

<div id="currencyModal" class="modal" onclick="closeModalOutside(event, 'currencyModal')">
    <div class="modal-content tool-modal-content">
        <div style="display:flex;justify-content:space-between; margin-bottom:15px;">
            <h3>ğŸ’± DÃ¶viz (Efektif SatÄ±ÅŸ)</h3><span onclick="closeModal('currencyModal')" style="cursor:pointer;font-size:24px;">&times;</span>
        </div>
        <div style="margin-bottom:15px;">
            <a href="https://www.tcmb.gov.tr/wps/wcm/connect/tr/tcmb+tr/main+page+site+area/bugun" target="_blank" class="tool-btn" style="width:100%; justify-content:center; text-align:center; background:#fef9e7; border:1px solid #f39c12; color:#d35400;"> TCMB KurlarÄ±nÄ± AÃ§ </a>
        </div>
        <div class="currency-board">
            <div class="currency-row">
                <span class="curr-flag">ğŸ‡ºğŸ‡¸ USD</span>
                <div><input type="number" id="usdRate" class="curr-input" style="width:80px; padding:5px; border:1px solid #ddd; border-radius:3px;"></div>
            </div>
            <div class="currency-row">
                <span class="curr-flag">ğŸ‡ªğŸ‡º EUR</span>
                <div><input type="number" id="eurRate" class="curr-input" style="width:80px; padding:5px; border:1px solid #ddd; border-radius:3px;"></div>
            </div>
        </div>
        <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
        <div class="form-group">
            <label>Ã‡evrilecek Tutar</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="calcCurrAmount" placeholder="1000" style="flex:2;">
                <select id="calcCurrType" style="flex:1;">
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                </select>
            </div>
        </div>
        <button class="btn-save" style="width:100%; margin-top:10px;" onclick="calculateCurrencyTotal()">HESAPLA (TL)</button>
        <div id="currencyTotalRes" class="result-box" style="margin-top:15px; padding:10px; background:#f0f9ff; text-align:center; font-weight:bold; display:none;">
            <span id="currResText">0,00 TL</span>
        </div>
    </div>
</div>

<div id="realEstateCalcModal" class="modal" onclick="closeModalOutside(event, 'realEstateCalcModal')">
    <div class="modal-content tool-modal-content">
        <div style="display:flex;justify-content:space-between; margin-bottom:10px;">
            <h3>ğŸ§¾ Emlak HesaplamalarÄ±</h3><span onclick="closeModal('realEstateCalcModal')" style="cursor:pointer;font-size:24px;">&times;</span>
        </div>
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('tabTapu')">Tapu & Kom.</button>
            <button class="tab-btn" onclick="switchTab('tabEmsal')">Emsal</button>
            <button class="tab-btn" onclick="switchTab('tabVergi')">Vergi</button>
        </div>
        <div id="tabTapu" class="tab-content active">
            <div class="form-group"><label>SatÄ±ÅŸ Bedeli (TL)</label><input type="text" id="calcPriceComp" placeholder="5.000.000" oninput="formatCurrency(this)"></div>
            <button class="btn-save" style="width:100%; margin-top:10px;" onclick="calcTapuKomisyon()">HESAPLA</button>
            <div id="resTapu" style="margin-top:10px; font-size:13px; font-weight:bold; display:none; background:#f9f9f9; padding:10px; border-radius:4px;"></div>
        </div>
        <div id="tabEmsal" class="tab-content">
            <div class="form-group"><label>Arsa (mÂ²)</label><input type="text" id="calcArsaM2" oninput="formatCurrency(this)"></div>
            <div class="form-group"><label>KAKS / Emsal</label><input type="text" id="calcKaks" placeholder="1.5"></div>
            <button class="btn-save" style="width:100%; margin-top:10px;" onclick="calcEmsal()">HESAPLA</button>
            <div id="resEmsal" style="margin-top:10px; font-weight:bold; display:none; background:#f9f9f9; padding:10px; border-radius:4px;"></div>
        </div>
        <div id="tabVergi" class="tab-content">
            <div class="form-group"><label>TÃ¼r</label><select id="calcVergiType"><option value="0.002">Konut (B.Åehir)</option><option value="0.004">Ä°ÅŸyeri (B.Åehir)</option><option value="0.006">Arsa (B.Åehir)</option></select></div>
            <div class="form-group"><label>RayiÃ§ Bedel</label><input type="text" id="calcVergiDeger" oninput="formatCurrency(this)"></div>
            <button class="btn-save" style="width:100%; margin-top:5px;" onclick="calcEmlakVergisi()">HESAPLA</button>
            <div id="resVergi" style="margin-top:10px; font-weight:bold; display:none; background:#f9f9f9; padding:10px; border-radius:4px;"></div>
        </div>
    </div>
</div>

<script>
    // --- GÃœVENLÄ°K KÄ°LÄ°T SÄ°STEMÄ° (v73'e ENTEGRE EDÄ°LDÄ°) ---
    // MÃ¼ÅŸteriye Ã¶zel salt anahtarÄ±. Bunu deÄŸiÅŸtirmeyin.
    const SECRET_SALT = "oKrCbY2015*";
    let deviceID = localStorage.getItem('karacabay_device_id');
    
    // Cihaz ID yoksa oluÅŸtur
    if (!deviceID) {
        // Rastgele 6 karakter (A-Z, 0-9)
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        deviceID = "";
        for(let i=0; i<6; i++) deviceID += chars.charAt(Math.floor(Math.random() * chars.length));
        localStorage.setItem('karacabay_device_id', deviceID);
    }
    
    // Cihaz ID'yi ekrana yaz
    document.getElementById('showDeviceID').innerText = deviceID;

    // ID Kopyalama Fonksiyonu
    function copyID() {
        if(navigator.clipboard) {
            navigator.clipboard.writeText(deviceID).then(() => {
                document.getElementById('copyHint').innerText = "âœ… KOPYALANDI!";
                setTimeout(() => document.getElementById('copyHint').innerText = "Kopyalamak iÃ§in koda dokunun", 2000);
            });
        } else {
            alert("Cihaz ID: " + deviceID);
        }
    }

    // Lisans DoÄŸrulama (Hash)
    async function verifyLicense() {
        const inputKey = document.getElementById('licenseKeyInput').value.trim().toUpperCase();
        if(!inputKey) return;

        // Girilen ID + Salt -> Hash Ã¼ret
        const validKey = await generateHash(deviceID + SECRET_SALT);

        if (inputKey === validKey) {
            // BaÅŸarÄ±lÄ±
            localStorage.setItem('karacabay_license_auth', inputKey);
            unlockApp();
        } else {
            // HatalÄ±
            const msg = document.getElementById('secMsg');
            msg.innerText = "â›” HATALI ÅÄ°FRE!";
            msg.style.display = 'block';
        }
    }

    // SHA-256 Hash Fonksiyonu
    async function generateHash(text) {
        const msgBuffer = new TextEncoder().encode(text);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        // Ä°lk 8 karakteri al ve bÃ¼yÃ¼k harf yap
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 8).toUpperCase();
    }

    // Kilidi AÃ§ ve UygulamayÄ± GÃ¶ster
    function unlockApp() {
        document.getElementById('lockScreen').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        
        // Uygulama baÅŸlatÄ±cÄ±larÄ± burada Ã§alÄ±ÅŸÄ±r
        // Saati baÅŸlat, dashboard'u gÃ¼ncelle vs.
        startClock(); 
        updateDashboard();
    }

    // Sayfa AÃ§Ä±lÄ±ÅŸÄ±nda Kontrol
    window.onload = async function() {
        const savedKey = localStorage.getItem('karacabay_license_auth');
        let unlocked = false;
        
        if (savedKey) {
            const validKey = await generateHash(deviceID + SECRET_SALT);
            if (savedKey === validKey) {
                unlocked = true;
                unlockApp();
            }
        }

        // EÄŸer kilit aÃ§Ä±ldÄ±ysa normal baÅŸlatma iÅŸlemlerini yap
        if(unlocked) {
            // Zaten unlockApp iÃ§inde yapÄ±lÄ±yor
        } else {
            // Kilit ekranÄ± kalÄ±r
        }

        // --- ORÄ°JÄ°NAL v73 BAÅLANGIÃ‡ FONKSÄ°YONLARI ---
        populateSelects(); 
        renderTable(); 
        renderChecklist();
        initImarLinks();
        // startClock ve updateDashboard unlockApp iÃ§inde Ã§aÄŸrÄ±lÄ±r
    };

    // --- ORÄ°JÄ°NAL v73 FONKSÄ°YONLARI (DOKUNULMADI) ---

    const floorList = ["GiriÅŸ AltÄ± Kot 4", "GiriÅŸ AltÄ± Kot 3", "GiriÅŸ AltÄ± Kot 2", "GiriÅŸ AltÄ± Kot 1", "Bodrum Kat", "Zemin Kat", "BahÃ§e KatÄ±", "BahÃ§e Dubleksi", "GiriÅŸ KatÄ±", "YÃ¼ksek GiriÅŸ", "MÃ¼stakil", "Villa Tipi", "Ã‡atÄ± KatÄ±"];
    for (let i = 1; i <= 30; i++) { floorList.push(i.toString()); } floorList.push("30+"); floorList.push("Ã‡atÄ± Dubleks");
    
    const antalyaData = { "Akseki": ["Merkez"], "Aksu": ["Merkez","AltÄ±ntaÅŸ","Kundu","PÄ±narlÄ±","Macun"], "Alanya": ["Merkez","Mahmutlar","Avsallar","Oba","Kestel"], "Demre": ["Merkez"], "DÃ¶ÅŸemealtÄ±": ["Merkez","YenikÃ¶y","YeÅŸilbayÄ±r","AltÄ±nkale"], "ElmalÄ±": ["Merkez"], "Finike": ["Merkez"], "GazipaÅŸa": ["Merkez"], "GÃ¼ndoÄŸmuÅŸ": ["Merkez"], "Ä°bradÄ±": ["Merkez"], "KaÅŸ": ["Merkez","Kalkan"], "Kemer": ["Merkez","GÃ¶ynÃ¼k","Beldibi","Tekirova"], "Kepez": ["Merkez","Varsak","SÃ¼tÃ§Ã¼ler","GÃ¼lveren","KÃ¼ltÃ¼r"], "KonyaaltÄ±": ["Merkez","Liman","Hurma","UncalÄ±","GÃ¼rsu","SarÄ±su"], "Korkuteli": ["Merkez"], "Kumluca": ["Merkez","Mavikent","Adrasan"], "Manavgat": ["Merkez","Side","Sorgun","IlÄ±ca"], "MuratpaÅŸa": ["Merkez","Lara","Fener","ÅirinyalÄ±","KÄ±rcami","Meltem"], "Serik": ["Merkez","Belek","Kadriye","BoÄŸazkent"] };
    const turkiyeData = { "Adana": [], "AdÄ±yaman": [], "Afyonkarahisar": [], "AÄŸrÄ±": [], "Aksaray": [], "Amasya": [], "Ankara": ["Ã‡ankaya","KeÃ§iÃ¶ren","Yenimahalle","Mamak","Etimesgut","Sincan","AltÄ±ndaÄŸ","Pursaklar","GÃ¶lbaÅŸÄ±"], "Antalya": Object.keys(antalyaData).sort(), "Ardahan": [], "Artvin": [], "AydÄ±n": [], "BalÄ±kesir": [], "BartÄ±n": [], "Batman": [], "Bayburt": [], "Bilecik": [], "BingÃ¶l": [], "Bitlis": [], "Bolu": [], "Burdur": [], "Bursa": [], "Ã‡anakkale": [], "Ã‡ankÄ±rÄ±": [], "Ã‡orum": [], "Denizli": [], "DiyarbakÄ±r": [], "DÃ¼zce": [], "Edirne": [], "ElazÄ±ÄŸ": [], "Erzincan": [], "Erzurum": [], "EskiÅŸehir": [], "Gaziantep": [], "Giresun": [], "GÃ¼mÃ¼ÅŸhane": [], "Hakkari": [], "Hatay": [], "IÄŸdÄ±r": [], "Isparta": [], "Ä°stanbul": ["Esenyurt","KÃ¼Ã§Ã¼kÃ§ekmece","BaÄŸcÄ±lar","Ãœmraniye","Pendik","BahÃ§elievler","ÃœskÃ¼dar","KadÄ±kÃ¶y","Kartal","GaziosmanpaÅŸa","ÅiÅŸli","BeÅŸiktaÅŸ","SarÄ±yer","Fatih"], "Ä°zmir": ["Buca","KarabaÄŸlar","Bornova","KarÅŸÄ±yaka","Konak","BayraklÄ±","Ã‡iÄŸli","Menemen","TorbalÄ±"], "KahramanmaraÅŸ": [], "KarabÃ¼k": [], "Karaman": [], "Kars": [], "Kastamonu": [], "Kayseri": [], "KÄ±rÄ±kkale": [], "KÄ±rklareli": [], "KÄ±rÅŸehir": [], "Kilis": [], "Kocaeli": [], "Konya": [], "KÃ¼tahya": [], "Malatya": [], "Manisa": [], "Mardin": [], "Mersin": [], "MuÄŸla": ["Bodrum","Fethiye","Marmaris","DatÃ§a","MenteÅŸe","Milas"], "MuÅŸ": [], "NevÅŸehir": [], "NiÄŸde": [], "Ordu": [], "Osmaniye": [], "Rize": [], "Sakarya": [], "Samsun": [], "Siirt": [], "Sinop": [], "Sivas": [], "ÅanlÄ±urfa": [], "ÅÄ±rnak": [], "TekirdaÄŸ": [], "Tokat": [], "Trabzon": [], "Tunceli": [], "UÅŸak": [], "Van": [], "Yalova": [], "Yozgat": [], "Zonguldak": [] };
    const typeList = ["Daire","Villa","Proje","Arsa","Ä°ÅŸyeri","Devre MÃ¼lk","Turistik Tesis","Otel","Komple Bina","BahÃ§e","Tarla","Zeytinlik"];

    let crmData = { investors: [], network: [] };
    let portfolio = [];
    let checklist = [];
    let imarLinks = [];
    
    // SAAT DEÄÄ°ÅKENLERÄ°
    let alarmTime = null;

    try { const sC = localStorage.getItem('KaracabayRE_CRM_v19'); if(sC) crmData = JSON.parse(sC); } catch(e){}
    try { const sP = localStorage.getItem('KaracabayRE_EST_DB_v19'); if(sP) portfolio = JSON.parse(sP); } catch(e){}
    try { const sCh = localStorage.getItem('KaracabayRE_CHK_v1'); if(sCh) checklist = JSON.parse(sCh); } catch(e){}
    try { const sIm = localStorage.getItem('KaracabayRE_IMAR_v1'); if(sIm) imarLinks = JSON.parse(sIm); } catch(e){}

    let editingId = null; let crmEditingId = null;

    // window.onload yukarÄ±da tanÄ±mlandÄ±ÄŸÄ± iÃ§in buradaki bloÄŸu kaldÄ±rdÄ±k ve fonksiyonlarÄ± yukarÄ± taÅŸÄ±dÄ±k.

    // --- SAAT & ALARM ---
    function startClock() {
        setInterval(() => {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('tr-TR', { hour12: false });
            document.getElementById('digitalClockDisplay').innerText = timeStr;

            // Alarm kontrolÃ¼ (Sadece saat ve dakika eÅŸleÅŸirse)
            if (alarmTime) {
                const currentHM = timeStr.substring(0, 5); // "14:30"
                if (currentHM === alarmTime) {
                    document.getElementById('digitalClockBox').classList.add('alarm-active');
                    // 1 dakika sonra alarmÄ± durdur ve sÄ±fÄ±rla
                    setTimeout(() => {
                        document.getElementById('digitalClockBox').classList.remove('alarm-active');
                        alarmTime = null;
                        document.getElementById('alarmTimeInput').value = '';
                    }, 60000); 
                }
            }
        }, 1000);
    }

    function toggleAlarmInput() {
        const inp = document.getElementById('alarmTimeInput');
        inp.style.display = inp.style.display === 'inline-block' ? 'none' : 'inline-block';
        if(inp.style.display === 'inline-block') inp.focus();
    }

    function setAlarm(val) {
        alarmTime = val;
        alert("Alarm kuruldu: " + val);
        document.getElementById('alarmTimeInput').style.display = 'none';
        document.getElementById('digitalClockBox').classList.remove('alarm-active');
    }

    // --- DASHBOARD (Ã–ZET PANELÄ°) ---
    function updateDashboard() {
        let satilik = 0, kiralik = 0, satildi = 0;
        portfolio.forEach(p => {
            if (p.status === 'SatÄ±lÄ±k') satilik++;
            else if (p.status === 'KiralÄ±k') kiralik++;
            else if (p.status === 'SatÄ±ldÄ±' || p.status === 'KiralandÄ±') satildi++;
        });
        document.getElementById('countSatilik').innerText = satilik;
        document.getElementById('countKiralik').innerText = kiralik;
        document.getElementById('countSatildi').innerText = satildi;
        document.getElementById('countTotal').innerText = portfolio.length;
    }

    function populateSelects() { 
        const iC = document.getElementById('inpCity'); const fC = document.getElementById('filterCity');
        iC.innerHTML = '<option value="Antalya">Antalya</option>'; fC.innerHTML = '<option value="all">TÃ¼m Ä°ller</option><option value="Antalya">Antalya</option>';
        Object.keys(turkiyeData).sort().forEach(city => { if(city !== "Antalya") { iC.innerHTML += `<option value="${city}">${city}</option>`; fC.innerHTML += `<option value="${city}">${city}</option>`; } });
        handleCityChange('inpCity', 'inpDistrict', 'dl_mahalle_ekle'); fC.value = "Antalya"; handleCityChange('filterCity', 'filterDistrict', 'dl_mahalle_filtre');
        const tS=document.getElementById('inpType'), fT=document.getElementById('filterType'); typeList.forEach(t=>{tS.innerHTML+=`<option>${t}</option>`;fT.innerHTML+=`<option>${t}</option>`;});
        const fL = document.getElementById('inpFloor'); fL.innerHTML = ''; floorList.forEach(f => { const opt = document.createElement('option'); opt.value = f; opt.innerText = f; fL.appendChild(opt); });
    }

    function saveToDisk() { localStorage.setItem('KaracabayRE_EST_DB_v19', JSON.stringify(portfolio)); localStorage.setItem('KaracabayRE_CRM_v19', JSON.stringify(crmData)); localStorage.setItem('KaracabayRE_CHK_v1', JSON.stringify(checklist)); localStorage.setItem('KaracabayRE_IMAR_v1', JSON.stringify(imarLinks)); updateDashboard(); }
    
    function downloadData() { const d = { portfolio: portfolio, crm: crmData, checklist: checklist, imarLinks: imarLinks }; const a = document.createElement('a'); a.href = "data:text/plain;charset=utf-8," + encodeURIComponent(JSON.stringify(d)); let dateStr = new Date().toISOString().split('T')[0]; a.download = "Karacabay_Yedek_" + dateStr + ".txt"; document.body.appendChild(a); a.click(); a.remove(); }
    function uploadData(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => { try { const raw = e.target.result; const d = JSON.parse(raw); if (Array.isArray(d)) { if(confirm("Eski format (v56) liste yedeÄŸi algÄ±landÄ±. YÃ¼klensin mi?")) { portfolio = d; if(!crmData || !crmData.investors) crmData = { investors: [], network: [] }; if(!checklist) checklist = []; if(!imarLinks) imarLinks = []; saveToDisk(); window.location.reload(); } } else if (d.portfolio || d.crm) { if(confirm("GÃ¼ncel sistem yedeÄŸi algÄ±landÄ±. YÃ¼klensin mi?")) { if(d.portfolio && Array.isArray(d.portfolio)) portfolio = d.portfolio; if(d.crm) crmData = d.crm; if(d.checklist) checklist = d.checklist; if(d.imarLinks) imarLinks = d.imarLinks; saveToDisk(); window.location.reload(); } } else { alert("UYARI: Dosya iÃ§eriÄŸi tanÄ±namadÄ±."); } } catch(err) { alert("Dosya okunamadÄ±. LÃ¼tfen geÃ§erli bir yedek dosyasÄ± seÃ§in.\nHata: " + err); } input.value = ''; }; r.readAsText(f); }

    function initImarLinks() { if (imarLinks.length === 0) { const defaults = [ {name: "MuratpaÅŸa (Resmi)", url: "https://muratpasa-bld.gov.tr/"}, {name: "MuratpaÅŸa (Alt)", url: "https://www.muratpasa.bel.tr/"}, {name: "Kepez", url: "https://www.kepez-bld.gov.tr/"}, {name: "KonyaaltÄ±", url: "https://www.konyaalti.bel.tr/"}, {name: "DÃ¶ÅŸemealtÄ±", url: "https://dosemealti.bel.tr/"}, {name: "Aksu", url: "https://www.aksu.bel.tr/"}, {name: "Alanya", url: "https://www.alanya.bel.tr/"} ]; imarLinks = defaults; localStorage.setItem('KaracabayRE_IMAR_v1', JSON.stringify(imarLinks)); } }
    function renderImarButtons() { const container = document.getElementById('imarListContainer'); container.innerHTML = ''; imarLinks.forEach((link, index) => { const div = document.createElement('div'); div.style.display = 'flex'; div.style.alignItems = 'center'; div.innerHTML = ` <button class="btn-imar-select" style="flex:1;" onclick="window.open('${link.url}', '_blank')"> ${link.name} <i class="fa-solid fa-arrow-up-right-from-square"></i> </button> <button class="btn-imar-delete" onclick="deleteImarLink(${index})" title="Sil"><i class="fa-solid fa-trash"></i></button> `; container.appendChild(div); }); }
    function addImarLink() { const city = document.getElementById('imarCityInput').value; const dist = document.getElementById('imarDistInput').value; const url = document.getElementById('imarUrlInput').value; if(!url) { alert("Link yapÄ±ÅŸtÄ±rÄ±n."); return; } let name = dist ? (city ? `${dist} (${city})` : dist) : (city || "Yeni Link"); imarLinks.push({ name: name, url: url }); localStorage.setItem('KaracabayRE_IMAR_v1', JSON.stringify(imarLinks)); renderImarButtons(); document.getElementById('imarUrlInput').value = ''; }
    function deleteImarLink(index) { if(confirm("Silinsin mi?")) { imarLinks.splice(index, 1); localStorage.setItem('KaracabayRE_IMAR_v1', JSON.stringify(imarLinks)); renderImarButtons(); } }
    function searchGoogleImar() { const dist = document.getElementById('imarDistInput').value; if(!dist) { alert("Ä°lÃ§e yazÄ±n."); return; } window.open(`https://www.google.com/search?q=${encodeURIComponent(dist + ' belediyesi imar durumu')}`, '_blank'); }

    function handleCityChange(citySelectId, districtElemId, datalistId) { const city = document.getElementById(citySelectId).value; const distElem = document.getElementById(districtElemId); document.getElementById(datalistId).innerHTML = ''; if(districtElemId === 'filterDistrict') { distElem.innerHTML = '<option value="all">Ä°lÃ§e</option>'; if (city !== "all" && turkiyeData[city]) { turkiyeData[city].sort().forEach(d => { const opt = document.createElement('option'); opt.value = d; opt.innerText = d; distElem.appendChild(opt); }); } } else { distElem.value = ''; const dl = document.getElementById('dl_ilce_ekle'); dl.innerHTML = ''; if (turkiyeData[city]) { turkiyeData[city].sort().forEach(d => { const opt = document.createElement('option'); opt.value = d; dl.appendChild(opt); }); } } }
    function loadMahalleler(citySelectId, districtElemId, datalistId) { const city = document.getElementById(citySelectId).value; const district = document.getElementById(districtElemId).value; const dl = document.getElementById(datalistId); dl.innerHTML = ''; if(city === "Antalya" && antalyaData[district]) { antalyaData[district].sort().forEach(m=>{ let o=document.createElement('option'); o.value=m; dl.appendChild(o); }); } }
    function clearFilters() { document.getElementById('searchBox').value = ''; document.getElementById('filterOwnership').value = 'all'; document.getElementById('filterType').value = 'all'; document.getElementById('filterStatus').value = 'all'; document.getElementById('filterCity').value = 'Antalya'; handleCityChange('filterCity', 'filterDistrict', 'dl_mahalle_filtre'); document.getElementById('filterDistrict').value = 'all'; document.getElementById('filterNeighborhood').value = ''; document.getElementById('filterRooms').value = ''; document.getElementById('filterMinPrice').value = ''; document.getElementById('filterMaxPrice').value = ''; const masterCb = document.getElementById('masterCheckbox'); if(masterCb) masterCb.checked = false; renderTable(); }

    function handleSave() {
        const data = { id: editingId ? editingId : Date.now(), ownership: document.getElementById('inpOwnership').value, type: document.getElementById('inpType').value, status: document.getElementById('inpStatus').value, city: document.getElementById('inpCity').value, district: document.getElementById('inpDistrict').value, neighborhood: document.getElementById('inpNeighborhood').value, rooms: document.getElementById('inpRooms').value, floor: document.getElementById('inpFloor').value, floorCount: document.getElementById('inpFloorCount').value, gross: document.getElementById('inpGross').value, net: document.getElementById('inpNet').value, price: document.getElementById('inpPrice').value, currency: document.getElementById('inpCurrency').value, authStart: document.getElementById('inpAuthStart').value, authEnd: document.getElementById('inpAuthEnd').value, ref: document.getElementById('inpRef').value, phone: document.getElementById('inpPhone').value, link: document.getElementById('inpLink').value, desc: document.getElementById('inpDesc').value };
        if(!data.district || !data.price) { alert("Ä°lÃ§e ve Fiyat zorunlu!"); return; }
        if (editingId) portfolio[portfolio.findIndex(p => p.id === editingId)] = data; else portfolio.push(data);
        saveToDisk(); renderTable(); resetForm();
    }

    function editRecord(id) {
        const item = portfolio.find(p => p.id === id); if(!item) return; editingId = id;
        document.getElementById('formTitle').innerText = "âœï¸ DÃ¼zenleniyor..."; document.getElementById('btnSave').innerText = "GÃœNCELLE"; document.getElementById('btnDelete').style.display = "block"; document.getElementById('btnCancel').style.display = "block";
        document.getElementById('inpOwnership').value = item.ownership || 'BANA AÄ°T'; document.getElementById('inpType').value = item.type; document.getElementById('inpStatus').value = item.status; document.getElementById('inpCity').value = item.city || "Antalya"; handleCityChange('inpCity', 'inpDistrict', 'dl_mahalle_ekle'); document.getElementById('inpDistrict').value = item.district; loadMahalleler('inpCity', 'inpDistrict', 'dl_mahalle_ekle'); setTimeout(() => { document.getElementById('inpNeighborhood').value = item.neighborhood; }, 50); document.getElementById('inpRooms').value = item.rooms; document.getElementById('inpFloor').value = item.floor; document.getElementById('inpFloorCount').value = item.floorCount || ''; document.getElementById('inpGross').value = item.gross; document.getElementById('inpNet').value = item.net; document.getElementById('inpPrice').value = item.price; document.getElementById('inpCurrency').value = item.currency || 'â‚º'; document.getElementById('inpAuthStart').value = item.authStart; document.getElementById('inpAuthEnd').value = item.authEnd; document.getElementById('inpRef').value = item.ref; document.getElementById('inpPhone').value = item.phone; document.getElementById('inpLink').value = item.link; document.getElementById('inpDesc').value = item.desc;
        window.scrollTo(0,0);
        // DÃ¼zenleme modunda komisyonu da hesaplat
        formatCurrency(document.getElementById('inpPrice'));
    }

    function toggleAllSelections(source) { const checkboxes = document.querySelectorAll('#tableBody input[type="checkbox"]'); checkboxes.forEach(cb => { cb.checked = source.checked; toggleRowSelection(cb); }); }
    function toggleRowSelection(checkbox) { const row = checkbox.closest('tr'); if(checkbox.checked) row.classList.add('row-selected'); else row.classList.remove('row-selected'); }
    function printSelected() { const selectedCount = document.querySelectorAll('.row-selected').length; if(selectedCount === 0) { alert("âš ï¸ YazdÄ±rÄ±lacak kayÄ±t seÃ§iniz."); return; } document.body.classList.add('print-selected-mode'); setTimeout(function() { window.print(); setTimeout(function() { document.body.classList.remove('print-selected-mode'); }, 2000); }, 100); }
    function sendSelectedToWhatsapp() { const selectedCheckboxes = document.querySelectorAll('.row-selected input[type="checkbox"]'); if(selectedCheckboxes.length === 0) { alert("LÃ¼tfen portfÃ¶y seÃ§in."); return; } let msg = "*ğŸ“¢ SEÃ‡Ä°LEN PORTFÃ–YLER*\n\n"; const filterCityVal = document.getElementById('filterCity').value; selectedCheckboxes.forEach(cb => { const row = cb.closest('tr'); const editBtn = row.querySelector('button[onclick^="editRecord"]'); if(editBtn) { const idMatch = editBtn.getAttribute('onclick').match(/\d+/); if(idMatch) { const id = parseInt(idMatch[0]); const item = portfolio.find(p => p.id === id); if(item) { const cityToUse = (filterCityVal !== 'all') ? filterCityVal : (item.city || 'Antalya'); const netInfo = item.net ? ` | ğŸ“ NET ${item.net} mÂ²` : ''; msg += `ğŸ  *${item.status} ${item.type}*\nğŸ“ ${cityToUse} / ${item.district} / ${item.neighborhood}\nğŸ”¢ ${item.rooms}${netInfo} | ğŸ’° ${item.price} ${item.currency||'â‚º'}\n-------------------\n`; } } } }); window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank'); }
    function exportSelectedToExcel() { const selectedRows = document.querySelectorAll('#tableBody tr.row-selected'); if(selectedRows.length === 0) { alert("âš ï¸ LÃ¼tfen Excel'e aktarmak istediÄŸiniz kayÄ±tlarÄ± soldaki kutucuktan seÃ§in."); return; } let originalTable = document.getElementById("portfolioTable"); let tableClone = originalTable.cloneNode(true); for (let i = tableClone.rows.length - 1; i >= 0; i--) { let row = tableClone.rows[i]; if(i > 0) { if(!row.classList.contains('row-selected')) { tableClone.deleteRow(i); continue; } } if(row.cells.length > 0) { row.deleteCell(10); row.deleteCell(9); row.deleteCell(8); row.deleteCell(0); for(let cell of row.cells) { cell.innerText = cell.innerText.replace(/\n/g, ' ').trim(); } } } let html = tableClone.outerHTML; let uri = 'data:application/vnd.ms-excel;base64,' + btoa(unescape(encodeURIComponent('<meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">' + html))); let link = document.createElement("a"); link.href = uri; link.style = "visibility:hidden"; let dateStr = new Date().toISOString().split('T')[0]; link.download = "Karacabay_Secilenler_" + dateStr + ".xls"; document.body.appendChild(link); link.click(); document.body.removeChild(link); }

    function renderTable() {
        const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
        const term = document.getElementById('searchBox').value.toLowerCase();
        const fOwn = document.getElementById('filterOwnership').value; const fStatus = document.getElementById('filterStatus').value; const fType = document.getElementById('filterType').value; const fCity = document.getElementById('filterCity').value; const fDist = document.getElementById('filterDistrict').value; const fNeigh = document.getElementById('filterNeighborhood').value.toLowerCase(); const fRoom = document.getElementById('filterRooms').value.toLowerCase(); const minP = parsePrice(document.getElementById('filterMinPrice').value); const maxP = parsePrice(document.getElementById('filterMaxPrice').value);
        const filtered = portfolio.filter(item => { const txt = (item.district + item.neighborhood + item.ref + item.phone + item.desc + item.type + (item.city||'')).toLowerCase(); const p = parsePrice(item.price); const own = item.ownership || 'BANA AÄ°T'; const roomVal = (item.rooms || '').toLowerCase(); const cityVal = item.city || "Antalya"; return txt.includes(term) && ((fOwn === 'all') || (own === fOwn)) && ((fType === 'all') || (item.type === fType)) && ((fStatus === 'all') || (item.status === fStatus)) && ((fCity === 'all') || (cityVal === fCity)) && ((fDist === 'all') || (item.district === fDist)) && (fNeigh === '' || item.neighborhood.toLowerCase().includes(fNeigh)) && (fRoom === '' || roomVal.includes(fRoom)) && (minP === 0 || p >= minP) && (maxP === 0 || p <= maxP); });
        filtered.sort((a, b) => { const getStatusScore = (s) => { if (s === 'SatÄ±ldÄ±') return 3; if (s === 'KiralandÄ±') return 2; return 1; }; const scoreA = getStatusScore(a.status); const scoreB = getStatusScore(b.status); if (scoreA !== scoreB) return scoreA - scoreB; if (scoreA === 1) { const ownerA = a.ownership || 'BANA AÄ°T'; const ownerB = b.ownership || 'BANA AÄ°T'; if (ownerA !== ownerB) return ownerA === 'BANA AÄ°T' ? -1 : 1; } return b.id - a.id; });
        filtered.forEach(item => { let badgeClass = item.status.includes('SatÄ±ldÄ±')||item.status.includes('KiralandÄ±') ? 'kirmizi-etiket' : (item.status==='KiralÄ±k'?'kiralik':'satilik'); let rowClass = item.status === 'SatÄ±ldÄ±' ? 'row-sold' : (item.status === 'KiralandÄ±' ? 'row-rented' : ''); let floorInfo = item.floor; if(item.floorCount) floorInfo += `<br><small>Top: ${item.floorCount}</small>`; let currSymbol = item.currency || 'â‚º'; let btnDesc = item.desc ? `<button onclick="document.getElementById('modalText').innerText='${item.desc.replace(/\n/g,'\\n').replace(/'/g, "\\'")}'; document.getElementById('descModal').style.display='block';" class="btn-icon no-print" style="background:#9b59b6;border:none;color:white;border-radius:3px;cursor:pointer;">ğŸ“</button>` : '-'; let own = item.ownership || 'BANA AÄ°T'; let ownBadgeClass = (own === 'PAYLAÅIMLI') ? 'badge-shared' : 'badge-own'; let ownLabel = (own === 'PAYLAÅIMLI') ? 'PAYLAÅIMLI' : 'BANA AÄ°T'; let cityDisplay = item.city && item.city !== "Antalya" ? `<b>${item.city}</b>/` : ""; let authWarningStyle = ""; if (item.authEnd) { const endDate = new Date(item.authEnd); const diffDays = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24)); if (diffDays < 0) authWarningStyle = "color: white; background: #c0392b; padding: 2px 5px; border-radius: 3px;"; else if (diffDays <= 7) authWarningStyle = "color: black; background: #f1c40f; padding: 2px 5px; border-radius: 3px;"; } let authHtml = item.authEnd ? `<span style="${authWarningStyle}">${item.authEnd}</span>` : '-'; let btnLinkHtml = '-'; if (item.link && item.link.trim() !== "") { btnLinkHtml = ''; item.link.split('\n').forEach(l => { let r = l.trim(); if(r){ let lbl="Link"; let cls=""; let isF=false; let icon = "fa-link"; if(r.includes("maps") || r.includes("goo.gl")) { lbl="KONUM"; cls="link-maps"; icon="fa-location-dot"; } else if(r.includes("sahibinden")) {lbl="Sahibinden";cls="link-sahibinden";} else if(r.includes("hepsi")) {lbl="HepsiEmlak";cls="link-hepsi";} else if(r.includes("facebook")||r.includes("instagram")){lbl="Sosyal";cls="link-sosyal";} else if(r.includes("â–¸")||/\.(pdf|docx?|txt|jpg|png)$/i.test(r)){lbl="Dosya";cls="link-dosya";isF=true;} let href=r; if(!isF && !href.startsWith('http')) href='https://'+href; if(isF) btnLinkHtml += `<button onclick="alert('Dosya Yolu:\\n${r.replace(/\\/g,'\\\\')}')" class="direct-link-btn ${cls} no-print" style="border:none;cursor:pointer;">${lbl}</button><br>`; else btnLinkHtml += `<a href="${href}" target="_blank" class="direct-link-btn ${cls} no-print"><i class="fa-solid ${icon}"></i> ${lbl}</a><br>`; } }); } tbody.innerHTML += ` <tr class="${rowClass}"> <td class="select-col-cell no-print"><input type="checkbox" onchange="toggleRowSelection(this)"></td> <td><span class="badge ${badgeClass}">${item.status}</span><br><span class="badge ${ownBadgeClass}">${ownLabel}</span><br><span class="type-text">${item.type.toUpperCase()}</span></td> <td>${cityDisplay}<b>${item.district}</b><br><small>${item.neighborhood}</small></td> <td>${item.rooms}<br><small>${floorInfo}</small></td> <td>${item.gross}/${item.net}</td> <td style="color:#27ae60;font-weight:bold;">${item.price} ${currSymbol}</td> <td>${item.ref}<br><small>${item.phone}</small></td> <td>${authHtml}</td> <td class="no-print">${btnLinkHtml}</td> <td class="no-print">${btnDesc}</td> <td class="no-print"><button onclick="editRecord(${item.id})" style="background:#3498db;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">âœ</button></td> <td class="print-only">${item.desc}</td> </tr>`; });
    }

    function resetForm() {
        editingId = null;
        document.getElementById('formTitle').innerText = "â• Yeni PortfÃ¶y Ekle"; document.getElementById('btnSave').innerText = "KAYDET"; document.getElementById('btnDelete').style.display = "none"; document.getElementById('btnCancel').style.display = "none"; document.querySelectorAll('.input-panel input, .input-panel select, .input-panel textarea').forEach(i => i.value = ''); document.getElementById('inpType').value = "Daire"; document.getElementById('inpStatus').value = "SatÄ±lÄ±k"; document.getElementById('inpCurrency').value = "â‚º"; document.getElementById('inpOwnership').value = "BANA AÄ°T"; document.getElementById('inpCity').value = "Antalya"; handleCityChange('inpCity', 'inpDistrict', 'dl_mahalle_ekle');
        document.getElementById('instantComm').style.display='none'; 
    }

    function openCRM() { openModal('crmModal'); renderInvestors(); renderNetwork(); document.getElementById('netLastCall').valueAsDate = new Date(); }
    function switchCRMTab(tab) { document.querySelectorAll('.crm-section').forEach(s => s.style.display = 'none'); document.querySelectorAll('.crm-tab').forEach(t => t.classList.remove('active')); if(tab === 'investors') { document.getElementById('crmInvestors').style.display = 'block'; document.getElementById('tab1').classList.add('active'); } else { document.getElementById('crmNetwork').style.display = 'block'; document.getElementById('tab2').classList.add('active'); } resetCRMForm('investors'); resetCRMForm('network'); }
    function saveCRMInvestor() { const inv = { id: crmEditingId ? crmEditingId : Date.now(), name: document.getElementById('invName').value, phone: document.getElementById('invPhone').value, type: document.getElementById('invType').value, region: document.getElementById('invRegion').value, budget: document.getElementById('invBudget').value, status: document.getElementById('invStatus').value, note: document.getElementById('invNote').value }; if(!inv.name) return; if(crmEditingId) crmData.investors[crmData.investors.findIndex(i => i.id === crmEditingId)] = inv; else crmData.investors.push(inv); saveCRM(); renderInvestors(); resetCRMForm('investors'); }
    function saveCRMNetwork() { const net = { id: crmEditingId ? crmEditingId : Date.now(), name: document.getElementById('netName').value, phone: document.getElementById('netPhone').value, job: document.getElementById('netJob').value, city: document.getElementById('netCity').value, relation: document.getElementById('netRelation').value, lastCall: document.getElementById('netLastCall').value || new Date().toISOString().split('T')[0], note: document.getElementById('netNote').value }; if(!net.name) return; if(crmEditingId) crmData.network[crmData.network.findIndex(n => n.id === crmEditingId)] = net; else crmData.network.push(net); saveCRM(); renderNetwork(); resetCRMForm('network'); }
    function deleteCRMInvestor() { if(confirm('Sil?')) { crmData.investors = crmData.investors.filter(i => i.id !== crmEditingId); saveCRM(); renderInvestors(); resetCRMForm('investors'); } }
    function deleteCRMNetwork() { if(confirm('Sil?')) { crmData.network = crmData.network.filter(n => n.id !== crmEditingId); saveCRM(); renderNetwork(); resetCRMForm('network'); } }
    function resetCRMForm(type) { crmEditingId = null; if(type === 'investors') { document.querySelectorAll('#crmInvestors input, #crmInvestors textarea').forEach(i=>i.value=''); document.getElementById('btnInvSave').innerText = "KAYDET"; document.getElementById('btnInvDelete').style.display = "none"; } else { document.querySelectorAll('#crmNetwork input, #crmNetwork textarea').forEach(i=>i.value=''); document.getElementById('netCity').value = 'Antalya'; document.getElementById('netLastCall').valueAsDate = new Date(); document.getElementById('btnNetSave').innerText = "KAYDET"; document.getElementById('btnNetDelete').style.display = "none"; } }

    function renderInvestors() { const tbody = document.getElementById('investorTableBody'); tbody.innerHTML = ''; crmData.investors.forEach(inv => { let sClass = inv.status==='SÄ±cak'?'badge-sicak':(inv.status==='IlÄ±k'?'badge-ilik':'badge-soguk'); tbody.innerHTML += `<tr><td><b>${inv.name}</b></td><td>${inv.phone}</td><td>${inv.type} - ${inv.region}</td><td>${inv.budget} TL</td><td><span class="badge ${sClass}">${inv.status}</span></td><td><small>${inv.note || '-'}</small></td><td><button onclick="editCRMInvestor(${inv.id})">DÃœZENLE</button></td></tr>`; }); }
    function renderNetwork() { const tbody = document.getElementById('networkTableBody'); tbody.innerHTML = ''; const today = new Date(); crmData.network.forEach(net => { let lastCallDate = new Date(net.lastCall || today); let diffTime = Math.abs(today - lastCallDate); let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); let statusBadge = ''; if(diffDays >= 45) { statusBadge = `<span class="badge-crm-danger">ğŸ“ ARA</span>`; } else { statusBadge = `<span class="badge-crm-safe">${diffDays} GÃ¼n Oldu</span>`; } tbody.innerHTML += ` <tr> <td><b>${net.name}</b></td> <td>${net.job}<br><small>${net.city}</small></td> <td>${net.phone}</td> <td>${net.relation}</td> <td>${net.lastCall}</td> <td style="text-align:center;">${statusBadge}</td> <td><small>${net.note || '-'}</small></td> <td style="display:flex; gap:5px; justify-content:center;"> <button onclick="resetNetworkTimer(${net.id})" style="background:#3498db; color:white; border:none; padding:4px 8px; border-radius:3px; cursor:pointer; font-size:11px;">ğŸ“ GÃ–RÃœÅTÃœM</button> <button onclick="editCRMNetwork(${net.id})" style="background:#f39c12; color:white; border:none; padding:4px 8px; border-radius:3px; cursor:pointer; font-size:11px;">DÃœZENLE</button> </td> </tr>`; }); }
    function resetNetworkTimer(id) { if(confirm("GÃ¶rÃ¼ÅŸme yapÄ±ldÄ± olarak iÅŸaretlensin mi? Tarih bugÃ¼n olacak.")) { const idx = crmData.network.findIndex(n => n.id === id); if(idx > -1) { crmData.network[idx].lastCall = new Date().toISOString().split('T')[0]; saveCRM(); renderNetwork(); } } }
    function editCRMInvestor(id) { const i = crmData.investors.find(x => x.id === id); if(!i) return; crmEditingId = id; document.getElementById('invName').value = i.name; document.getElementById('invPhone').value = i.phone; document.getElementById('invType').value = i.type; document.getElementById('invRegion').value = i.region; document.getElementById('invBudget').value = i.budget; document.getElementById('invStatus').value = i.status; document.getElementById('invNote').value = i.note; document.getElementById('btnInvSave').innerText = "GÃœNCELLE"; document.getElementById('btnInvDelete').style.display = "inline-block"; }
    function editCRMNetwork(id) { const n = crmData.network.find(x => x.id === id); if(!n) return; crmEditingId = id; document.getElementById('netName').value = n.name; document.getElementById('netPhone').value = n.phone; document.getElementById('netJob').value = n.job; document.getElementById('netCity').value = n.city; document.getElementById('netRelation').value = n.relation; document.getElementById('netNote').value = n.note; document.getElementById('netLastCall').value = n.lastCall; document.getElementById('btnNetSave').innerText = "GÃœNCELLE"; document.getElementById('btnNetDelete').style.display = "inline-block"; }
    function saveCRM() { localStorage.setItem('KaracabayRE_CRM_v19', JSON.stringify(crmData)); }

    let calcExp = ""; function calcInput(v) { if(v === '%') { calcExp += '/100'; } else { calcExp += v; } document.getElementById('calcDisplay').value = calcExp; } function calcClear() { calcExp = ""; document.getElementById('calcDisplay').value = ""; } function calcResult() { try { calcExp = eval(calcExp).toString(); document.getElementById('calcDisplay').value = calcExp; } catch(e) { document.getElementById('calcDisplay').value = "Hata"; calcExp=""; } }
    async function fetchCurrency() { try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/TRY'); const data = await res.json(); if(document.getElementById('usdRate').value === "") document.getElementById('usdRate').value = (1 / data.rates.USD).toFixed(4); if(document.getElementById('eurRate').value === "") document.getElementById('eurRate').value = (1 / data.rates.EUR).toFixed(4); } catch(e) {} }
    function calculateCurrencyTotal() { let amount = parseFloat(document.getElementById('calcCurrAmount').value); let type = document.getElementById('calcCurrType').value; let rate = type === 'USD' ? parseFloat(document.getElementById('usdRate').value) : parseFloat(document.getElementById('eurRate').value); if(!amount || !rate) return; document.getElementById('currResText').innerText = (amount * rate).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " TL"; document.getElementById('currencyTotalRes').style.display = 'block'; }
    function switchTab(id) { document.querySelectorAll('.tab-content').forEach(d => d.style.display='none'); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(id).style.display = 'block'; event.currentTarget.classList.add('active'); }
    
    function calcTapuKomisyon() { 
        let rawVal = document.getElementById('calcPriceComp').value;
        let p = parsePrice(rawVal);
        if(!p || p <= 0) {
            document.getElementById('resTapu').innerHTML = "<span style='color:red;'>LÃ¼tfen geÃ§erli bir satÄ±ÅŸ bedeli giriniz.</span>";
            document.getElementById('resTapu').style.display = 'block';
            return; 
        }
        let tapu = p * 0.04; 
        let hizmet = p * 0.02; 
        let kdv = hizmet * 0.20;
        let topHizmet = hizmet + kdv;
        document.getElementById('resTapu').innerHTML = 
            `Tapu HarcÄ± (%4): <b>${tapu.toLocaleString('tr-TR')} TL</b><br>` +
            `Hizmet Bedeli (%2): <b>${hizmet.toLocaleString('tr-TR')} TL</b><br>` +
            `KDV (%20): <b>${kdv.toLocaleString('tr-TR')} TL</b><br>` +
            `--------------------------<br>` +
            `TOPLAM KOMÄ°SYON: <b style='color:#c0392b'>${topHizmet.toLocaleString('tr-TR')} TL</b>`;
        document.getElementById('resTapu').style.display = 'block'; 
    }
    
    function calcEmsal() { 
        let m2 = parsePrice(document.getElementById('calcArsaM2').value); 
        let kaks = parseFloat(document.getElementById('calcKaks').value); 
        if(!m2 || !kaks) {
             document.getElementById('resEmsal').innerHTML = "<span style='color:red;'>LÃ¼tfen mÂ² ve emsal giriniz.</span>";
             document.getElementById('resEmsal').style.display = 'block';
             return;
        }
        document.getElementById('resEmsal').innerHTML = `Ä°nÅŸaat AlanÄ±: <strong>${(m2*kaks).toLocaleString()} mÂ²</strong>`; 
        document.getElementById('resEmsal').style.display = 'block'; 
    }
    
    function calcEmlakVergisi() { 
        let rawVal = document.getElementById('calcVergiDeger').value;
        let val = parsePrice(rawVal); 
        let rate = parseFloat(document.getElementById('calcVergiType').value); 
        if(!val || val <= 0) {
            document.getElementById('resVergi').innerHTML = "<span style='color:red;'>LÃ¼tfen rayiÃ§ bedel giriniz.</span>";
            document.getElementById('resVergi').style.display = 'block';
            return; 
        }
        document.getElementById('resVergi').innerHTML = `YÄ±llÄ±k Vergi TutarÄ±: <strong style='color:#27ae60; font-size:1.2em;'>${(val*rate).toLocaleString('tr-TR')} TL</strong>`; 
        document.getElementById('resVergi').style.display = 'block'; 
    }

    function parsePrice(p) { 
        if (!p) return 0; 
        let clean = p.toString().trim().replace(/\./g, '').replace(/,/g, '.');
        let val = parseFloat(clean);
        return isNaN(val) ? 0 : val;
    }
    
    function formatCurrency(input) { 
        let v = input.value.replace(/\D/g, ''); 
        if(v) {
            let val = parseFloat(v);
            input.value = val.toLocaleString('tr-TR'); 
            if(input.id === 'inpPrice') {
                let comm = val * 0.02;
                let commKdv = comm * 1.20;
                let commBox = document.getElementById('instantComm');
                commBox.style.display = 'block';
                commBox.innerHTML = `Hizmet Bedeli (%2): ${comm.toLocaleString('tr-TR')} TL <span style="color:#7f8c8d; font-weight:normal;">(+KDV: ${commKdv.toLocaleString('tr-TR')} TL)</span>`;
            }
        } else { 
            input.value = ''; 
            if(input.id === 'inpPrice') document.getElementById('instantComm').style.display='none';
        } 
    }
    
    function formatPhone(input) { let v = input.value.replace(/\D/g,''); if(v.length>1)v=v.substring(0,1)==='0'?v.substring(1):v; let f=v.match(/^(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})$/); if(f) input.value=!f[2]?f[1]:'0 ('+f[1]+') '+f[2]+(f[3]?' '+f[3]:'')+(f[4]?' '+f[4]:''); }
    function autoResize(textarea) { textarea.style.height='auto'; textarea.style.height=textarea.scrollHeight+'px'; }
    function openModal(id){ document.getElementById(id).style.display='block'; }
    function closeModal(id){ document.getElementById(id).style.display='none'; }
    function closeModalOutside(e, id){ if(e.target === document.getElementById(id)) closeModal(id); }

    function renderChecklist(){ const c=document.getElementById('checklistContainer');c.innerHTML='';let u=0;checklist.forEach((item,i)=>{if(!item.checked)u++; const d=document.createElement('div');d.className='checklist-item '+(item.checked?'checked':'');d.innerHTML=`<span onclick="toggleCheck(${i})">${item.text}</span><button class="btn-delete-rec" style="display:block;height:20px;padding:0 5px;" onclick="deleteCheckItem(${i})">Sil</button>`;c.appendChild(d);});document.getElementById('chkBadge').innerText=u;document.getElementById('chkBadge').style.display=u>0?'block':'none';}
    function addCheckItem(){ const t=document.getElementById('newCheckItem').value;if(!t)return;checklist.push({text:t,checked:false});localStorage.setItem('KaracabayRE_CHK_v1',JSON.stringify(checklist));document.getElementById('newCheckItem').value='';renderChecklist();}
    function toggleCheck(i){ checklist[i].checked=!checklist[i].checked;localStorage.setItem('KaracabayRE_CHK_v1',JSON.stringify(checklist));renderChecklist();}
    function deleteCheckItem(i){ checklist.splice(i,1);localStorage.setItem('KaracabayRE_CHK_v1',JSON.stringify(checklist));renderChecklist();}
    function deleteFromForm() { if(confirm("KayÄ±t silinsin mi?")) { portfolio = portfolio.filter(p => p.id !== editingId); saveToDisk(); renderTable(); resetForm(); } }
</script>
</body>
</html>
